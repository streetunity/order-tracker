# Order Tracker - Complete AWS Deployment Reference

## Quick Reference Commands

### Most Used Commands
```bash
# Check system health
./verify-deployment.sh

# Fix any issues automatically
./fix-common-issues.sh

# Reset database to clean state
./reset-database.sh

# Quick reset (no confirmation)
./quick-reset.sh

# View service status
pm2 status

# View logs
pm2 logs
```

## Server Information
- **Server IP**: 50.19.66.100
- **Frontend URL**: http://50.19.66.100:3000
- **Backend API**: http://50.19.66.100:4000
- **Deploy Directory**: `/var/www/order-tracker`
- **Database**: `/var/www/order-tracker/api/prisma/dev.db`

## Default Credentials
- **Admin**: admin@stealthmachinetools.com / admin123
- **Agent**: john@stealthmachinetools.com / agent123
- **⚠️ IMPORTANT**: Change these passwords immediately in production!

## The Two Main Issues We Fixed

### 1. Database Read-Only Error (Login Fails)
**Problem**: Database file didn't have write permissions, causing login to fail when trying to update lastLogin timestamp.

**Solution**:
```bash
sudo chown ubuntu:ubuntu /var/www/order-tracker/api/prisma/dev.db
sudo chmod 664 /var/www/order-tracker/api/prisma/dev.db
sudo chown ubuntu:ubuntu /var/www/order-tracker/api/prisma/
sudo chmod 775 /var/www/order-tracker/api/prisma/
pm2 restart order-tracker-backend
```

### 2. Measurements Won't Save (Data Type Error)
**Problem**: Frontend sends measurements as strings ("100") but database expects Float numbers.

**Solution**: The API now converts strings to numbers automatically using `parseFloat()`. This fix is already applied in the deployment script.

## Deployment Scripts

### 1. deploy-aws.sh
Main deployment script that:
- Installs all dependencies
- Sets up database with correct permissions
- Configures environment variables
- Applies measurement fix
- Tests everything automatically

```bash
cd /var/www/order-tracker
./deploy-aws.sh
```

### 2. verify-deployment.sh
Health check script that checks:
- Database permissions
- Environment variables
- PM2 service status
- API endpoints
- Login functionality

```bash
./verify-deployment.sh
```

### 3. fix-common-issues.sh
Automatic issue resolver that fixes:
- Database permissions
- Missing JWT_SECRET
- Frontend API URLs
- Measurement data types
- Service restarts

```bash
./fix-common-issues.sh
```

### 4. reset-database.sh
Clears all data and reseeds with default users:
- Asks for confirmation
- Creates backup
- Deletes all orders/items/accounts
- Recreates clean database
- Seeds default users

```bash
./reset-database.sh
```

### 5. quick-reset.sh
Same as reset-database.sh but without confirmation prompt:

```bash
./quick-reset.sh
```

## PM2 Service Management

```bash
# Check status
pm2 status

# View all logs
pm2 logs

# View specific service logs
pm2 logs order-tracker-backend --lines 100
pm2 logs order-tracker-frontend --lines 100

# Restart services
pm2 restart all
pm2 restart order-tracker-backend
pm2 restart order-tracker-frontend

# Stop services
pm2 stop all

# Start services
pm2 start all

# Monitor resources
pm2 monit

# Clear logs
pm2 flush
```

## Database Operations

### Access Database
```bash
sqlite3 /var/www/order-tracker/api/prisma/dev.db
```

### Common Queries
```sql
-- Check users
SELECT email, name, role, isActive FROM User;

-- Count orders
SELECT COUNT(*) FROM "Order";

-- Count items
SELECT COUNT(*) FROM OrderItem;

-- Check recent orders
SELECT id, poNumber, currentStage, createdAt 
FROM "Order" 
ORDER BY createdAt DESC 
LIMIT 10;

-- Exit SQLite
.quit
```

### Reset Admin Password
```bash
cd /var/www/order-tracker/api

# Generate new password hash
node -e "const bcrypt = require('bcryptjs'); bcrypt.hash('newpassword', 10).then(console.log);"

# Copy the hash and update database
sqlite3 prisma/dev.db
UPDATE User SET password='<paste-hash-here>' WHERE email='admin@stealthmachinetools.com';
.quit

# Restart backend
pm2 restart order-tracker-backend
```

### Backup Database
```bash
cp api/prisma/dev.db api/prisma/dev.db.backup.$(date +%Y%m%d_%H%M%S)
```

### Restore Database
```bash
cp api/prisma/dev.db.backup.20250923_120000 api/prisma/dev.db
pm2 restart order-tracker-backend
```

## Environment Configuration

### API Environment (/var/www/order-tracker/api/.env)
```env
NODE_ENV=production
DATABASE_URL=file:./prisma/dev.db
JWT_SECRET=<auto-generated-secret>
PORT=4000
CORS_ORIGIN=http://50.19.66.100:3000,http://50.19.66.100
SERVER_IP=50.19.66.100
```

### Frontend Environment (/var/www/order-tracker/web/.env.local)
```env
NEXT_PUBLIC_API_BASE=http://50.19.66.100:4000
NEXT_PUBLIC_API_URL=http://50.19.66.100:4000
API_BASE=http://localhost:4000
```

## Testing Endpoints

### Test API Health
```bash
curl http://localhost:4000/auth/check
```

### Test Login
```bash
curl -X POST http://localhost:4000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@stealthmachinetools.com","password":"admin123"}'
```

### Test from External
```bash
curl http://50.19.66.100:4000/auth/check
curl http://50.19.66.100:3000
```

## Troubleshooting Quick Fixes

### If Login Fails
```bash
# Fix database permissions
sudo chmod 664 /var/www/order-tracker/api/prisma/dev.db
sudo chown ubuntu:ubuntu /var/www/order-tracker/api/prisma/dev.db
pm2 restart order-tracker-backend
```

### If Frontend Can't Connect to API
```bash
# Fix frontend environment
cat > /var/www/order-tracker/web/.env.local << EOF
NEXT_PUBLIC_API_BASE=http://50.19.66.100:4000
NEXT_PUBLIC_API_URL=http://50.19.66.100:4000
API_BASE=http://localhost:4000
EOF

# Rebuild frontend
cd /var/www/order-tracker/web
npm run build
pm2 restart order-tracker-frontend
```

### If JWT Secret Missing
```bash
echo "JWT_SECRET=jwt-secret-$(openssl rand -hex 32)" >> /var/www/order-tracker/api/.env
pm2 restart order-tracker-backend
```

### If PM2 Process Errored
```bash
# Check logs for error
pm2 logs order-tracker-backend --err --lines 50

# For backend issues
cd /var/www/order-tracker/api
npm install
npx prisma generate
pm2 restart order-tracker-backend

# For frontend issues
cd /var/www/order-tracker/web
npm install
npm run build
pm2 restart order-tracker-frontend
```

## Update from Git

```bash
cd /var/www/order-tracker

# Fix git permissions if needed
sudo chown -R ubuntu:ubuntu .git

# Pull latest changes
git pull

# Install any new dependencies
cd api && npm install && cd ..
cd web && npm install && npm run build && cd ..

# Restart services
pm2 restart all
```

## Complete System Reset

```bash
cd /var/www/order-tracker

# Stop everything
pm2 delete all

# Backup current state
mkdir -p backups
cp api/prisma/dev.db backups/dev.db.$(date +%Y%m%d_%H%M%S)
cp api/.env backups/api.env.backup
cp web/.env.local backups/web.env.backup

# Clean and rebuild
cd api
rm -rf node_modules prisma/dev.db
npm install
npx prisma generate
npx prisma db push
node prisma/seed.js
sudo chown ubuntu:ubuntu prisma/dev.db
sudo chmod 664 prisma/dev.db

cd ../web
rm -rf node_modules .next
npm install
npm run build

cd ..

# Start everything
pm2 start api/src/index.js --name order-tracker-backend
pm2 start web/npm --name order-tracker-frontend -- start
pm2 save
```

## File Locations

### Configuration Files
- API Environment: `/var/www/order-tracker/api/.env`
- Frontend Environment: `/var/www/order-tracker/web/.env.local`
- Database: `/var/www/order-tracker/api/prisma/dev.db`
- PM2 Config: `~/.pm2/`

### Log Files
- PM2 Logs: `~/.pm2/logs/`
- Backend Logs: `~/.pm2/logs/order-tracker-backend-*.log`
- Frontend Logs: `~/.pm2/logs/order-tracker-frontend-*.log`

### Backup Files
- Database backups: `/var/www/order-tracker/api/prisma/dev.db.backup.*`
- Code backups: `/var/www/order-tracker/api/src/index.js.backup.*`

## Testing Workflow

### For Development Testing
```bash
# 1. Reset to clean state
./quick-reset.sh

# 2. Add test data through the app
# - Create accounts
# - Add orders
# - Test measurements

# 3. Reset again for next test
./quick-reset.sh
```

### Before Client Delivery
```bash
# 1. Full reset with confirmation
./reset-database.sh

# 2. Verify clean state
./verify-deployment.sh

# 3. Test login works
curl -X POST http://localhost:4000/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@stealthmachinetools.com","password":"admin123"}'

# 4. Access frontend
# http://50.19.66.100:3000
```

## Critical Notes

1. **Database Permissions**: Must be 664 and owned by ubuntu:ubuntu
2. **JWT_SECRET**: Must be set in api/.env
3. **Frontend API URL**: Must point to server IP, not localhost
4. **Measurement Fix**: parseFloat() conversion is applied automatically
5. **PM2 Process Names**: 
   - Backend: `order-tracker-backend`
   - Frontend: `order-tracker-frontend`

## Success Indicators

After deployment or fixes, you should see:
- ✅ PM2 shows both processes "online"
- ✅ Database file has 664 permissions
- ✅ JWT_SECRET exists in api/.env
- ✅ Frontend .env.local has correct IP
- ✅ Login returns a token
- ✅ Measurements save without errors

## Repository Information
- **GitHub**: https://github.com/streetunity/order-tracker
- **Branch**: aws-deployment
- **Server**: Ubuntu AWS EC2
- **Node Version**: 20.x
- **Database**: SQLite3
- **Frontend**: Next.js
- **Backend**: Express + Prisma

---

**Created**: September 2025
**Last Updated**: September 23, 2025
**Purpose**: Complete reference for Order Tracker AWS deployment and maintenance