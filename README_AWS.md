# Order Tracker - AWS Deployment Guide

## Quick Start

```bash
# Clone the repository
cd /var/www
sudo git clone -b aws-deployment https://github.com/streetunity/order-tracker.git
sudo chown -R ubuntu:ubuntu order-tracker
cd order-tracker

# Run deployment
./deploy-aws.sh

# Verify deployment
./verify-deployment.sh
```

Access your application at: **http://50.19.66.100:3000**

## Prerequisites

- Ubuntu Server (tested on AWS EC2)
- Node.js 20.x or higher
- PM2 installed globally (`npm install -g pm2`)
- Git
- At least 1GB RAM
- Ports 3000 and 4000 open in security group

## What's Included

### Deployment Scripts

1. **`deploy-aws.sh`** - Main deployment script
   - Installs all dependencies
   - Sets up database with correct permissions
   - Configures environment variables
   - Applies all necessary fixes
   - Starts services with PM2
   - Tests deployment automatically

2. **`verify-deployment.sh`** - Health check script
   - Checks database permissions
   - Verifies environment variables
   - Tests API endpoints
   - Reports system status

3. **`fix-common-issues.sh`** - Automatic issue resolver
   - Fixes database permissions
   - Ensures JWT_SECRET is set
   - Fixes frontend API URLs
   - Applies measurement data type fix
   - Restarts services

## Architecture

```
┌─────────────────┐       ┌─────────────────┐
│                 │       │                 │
│   Frontend      │──────▶│   Backend API   │
│   (Next.js)     │       │   (Express)     │
│   Port 3000     │       │   Port 4000     │
│                 │       │                 │
└─────────────────┘       └─────────────────┘
                                 │
                                 ▼
                          ┌─────────────────┐
                          │                 │
                          │   SQLite DB     │
                          │   (dev.db)      │
                          │                 │
                          └─────────────────┘
```

## File Structure

```
/var/www/order-tracker/
├── api/                    # Backend API
│   ├── src/               # Source code
│   ├── prisma/            # Database schema and migrations
│   │   └── dev.db        # SQLite database file
│   └── .env              # API environment variables
├── web/                   # Frontend application
│   ├── src/              # Source code
│   ├── .next/            # Built frontend (generated)
│   └── .env.local        # Frontend environment variables
├── deploy-aws.sh         # Deployment script
├── verify-deployment.sh  # Health check script
└── fix-common-issues.sh  # Issue resolver script
```

## Services

The application runs two PM2 services:

1. **order-tracker-backend** - Express API server
2. **order-tracker-frontend** - Next.js frontend server

Manage services with:
```bash
pm2 status              # Check status
pm2 restart all         # Restart both services
pm2 logs                # View logs
pm2 monit               # Monitor resources
```

## Configuration

### API Configuration (`api/.env`)
```env
NODE_ENV=production
DATABASE_URL=file:./prisma/dev.db
JWT_SECRET=<auto-generated>
PORT=4000
CORS_ORIGIN=http://50.19.66.100:3000,http://50.19.66.100
SERVER_IP=50.19.66.100
```

### Frontend Configuration (`web/.env.local`)
```env
NEXT_PUBLIC_API_BASE=http://50.19.66.100:4000
NEXT_PUBLIC_API_URL=http://50.19.66.100:4000
API_BASE=http://localhost:4000
```

## Key Features Fixed for AWS

1. **Database Permissions** - Automatically sets correct permissions (664) to prevent read-only errors
2. **JWT Secret** - Auto-generates secure JWT secret if missing
3. **Measurement Data Types** - Converts string inputs to Float for database compatibility
4. **CORS Configuration** - Properly configured for AWS IP
5. **Environment Variables** - Automatically creates correct .env files

## Common Operations

### Change Admin Password
```bash
cd /var/www/order-tracker/api
# Generate new password hash
node -e "const bcrypt = require('bcryptjs'); bcrypt.hash('newpassword', 10).then(console.log);"
# Update in database (use the hash from above)
sqlite3 prisma/dev.db "UPDATE User SET password='<hash>' WHERE email='admin@stealthmachinetools.com';"
pm2 restart order-tracker-backend
```

### Backup Database
```bash
cp api/prisma/dev.db api/prisma/dev.db.backup.$(date +%Y%m%d)
```

### Update from Git
```bash
cd /var/www/order-tracker
git pull
npm install --prefix api
npm install --prefix web
npm run build --prefix web
pm2 restart all
```

### View Logs
```bash
# All logs
pm2 logs

# Backend only
pm2 logs order-tracker-backend --lines 100

# Frontend only
pm2 logs order-tracker-frontend --lines 100

# Errors only
pm2 logs --err
```

## Troubleshooting

If anything goes wrong:

1. **First, try the automatic fixer:**
   ```bash
   ./fix-common-issues.sh
   ```

2. **Check system health:**
   ```bash
   ./verify-deployment.sh
   ```

3. **Check logs for specific errors:**
   ```bash
   pm2 logs --lines 100
   ```

4. **See TROUBLESHOOTING.md for detailed solutions**

## Security Considerations

1. **Change default passwords immediately**
2. **Use HTTPS in production** (configure nginx/apache as reverse proxy)
3. **Restrict database file permissions** (already handled by scripts)
4. **Keep JWT_SECRET secure** (auto-generated, don't share)
5. **Regular backups** of the database file
6. **Monitor logs** for suspicious activity

## Performance Tips

1. **PM2 Cluster Mode** for multiple CPU cores:
   ```bash
   pm2 start api/src/index.js -i max
   ```

2. **Log Rotation** to prevent disk fill:
   ```bash
   pm2 install pm2-logrotate
   pm2 set pm2-logrotate:max_size 10M
   ```

3. **Monitor Memory** usage:
   ```bash
   pm2 monit
   ```

## Support Files

- **DEPLOYMENT_NOTES.md** - Detailed deployment information
- **TROUBLESHOOTING.md** - Common issues and solutions
- **README_AWS.md** - This file

## License

MIT

---

**Last Updated**: September 2025
**Tested On**: Ubuntu 22.04 LTS on AWS EC2
**Node Version**: 20.x
**Contact**: GitHub Issues